<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create a UYBOOK</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    textarea { width: 100%; height: 150px; }
    #funFact { margin-top: 40px; font-style: italic; color: #666; }
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>Create a UYBOOK</h1>

  <label>
    Title:
    <input type="text" id="title" placeholder="Book title" />
  </label>

  <label>
    Author:
    <input type="text" id="author" placeholder="Author name" />
  </label>

  <label>
    Description:
    <textarea id="description" placeholder="Short description"></textarea>
  </label>

  <label>
    HTML Content:
    <textarea id="content" placeholder="Paste your HTML here"></textarea>
  </label>

  <label>
    Cover image:
    <input type="file" id="coverFile" accept="image/*" />
  </label>

  <button id="saveBtn">Generate and download (.uybook)</button>

  <div id="funFact">ðŸ’¡ Fun Fact: If you print this page, the internet gets one byte heavier.</div>

  <script type="module">
    function encode(str) {
      return encodeURIComponent(String(str));
    }

    function buildBookRaw(meta, html) {
      const metaEntries = Object.entries(meta)
        .filter(([key]) => !['highlights', 'notes', 'scrollY', 'cover'].includes(key))
        .map(([key, value]) => `@${key}:'${encode(value)}'`);

      if (meta.highlights?.length) {
        metaEntries.push(`@highlights:'${encode(JSON.stringify(meta.highlights))}'`);
      }
      if (meta.notes?.length) {
        metaEntries.push(`@notes:'${encode(JSON.stringify(meta.notes))}'`);
      }
      if (meta.scrollY) {
        metaEntries.push(`@scrollY:'${meta.scrollY}'`);
      }

      const metaPart = `.meta:${metaEntries.join(',')};`;
      const htmlPart = `.bytes:[${html}];`;

      let raw = `${metaPart}\n${htmlPart}`;
      if (meta.cover) {
        raw += `\n.cover:${meta.cover}`;
      }

      return raw;
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const title = document.getElementById('title').value.trim();
      const author = document.getElementById('author').value.trim();
      const description = document.getElementById('description').value.trim();
      const content = document.getElementById('content').value.trim();

      if (!title || !author || !content) {
        alert('Title, author and HTML content are required.');
        return;
      }

      let coverBase64 = null;
      const coverFile = document.getElementById('coverFile').files[0];
      if (coverFile) {
        coverBase64 = await readFileAsBase64(coverFile);
      }

      const meta = {
        title,
        author,
        description,
        highlights: [],
        notes: [],
        scrollY: 0,
        cover: coverBase64,
      };

      const raw = buildBookRaw(meta, content);

      const blob = new Blob([raw], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title.replace(/\s+/g, '_')}.uybook`;
      a.click();
      URL.revokeObjectURL(url);
    });

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>

</body>
</html>
